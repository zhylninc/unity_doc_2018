<html><head><title>html模版</title></head><body>Unity - Manual: Profiling</br>
<div class="breadcrumbs clear"><ul>
<li><a href="UnityManual.html">Unity User Manual (2018.1 beta)</a></li>
<li><a href="PlatformSpecific.html">Platform-specific</a></li>
<li><a href="MobileDeveloperChecklist.html">Mobile Developer Checklist</a></li>
<li>Profiling</li>
</ul></div>
<div class="mb20"><div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="MobileCrashes.html"></a></span><div class="tip">Crashes</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="MobileOptimisation.html"></a></span><div class="tip">Optimizations</div>
</div>
</div></div>
<div class="otherversionswrapper" onmouseover="setOtherVersionsDisplay(true)" onmouseout="setOtherVersionsDisplay(false)">
<a>Other Versions</a><div class="otherversionscontent" id="OtherVersionsContent" style="display: none;">Cannot access other versions offline!</div>
</div>
<div class="scrollToFeedback"><a id="scrollToFeedback">Leave feedback</a></div>
<h1>Profiling</h1>
<!--BeginSwitchLink--><!--EndSwitchLink-->
<div class="clear"></div>

<h2>First steps</h2>

<p>Unity relies on the CPU (heavily optimized for the SIMD part of it, like SSE on x86 or NEON on ARM) for skinning, batching, physics, user scripts, particles, etc. </p>

<p>The GPU is used for shaders, drawcalls, image effects.</p>

<h3>CPU or GPU bound</h3>

<ul>
<li>Use the internal profiler to detect the CPU and GPU ms</li>
</ul>

<h3>Pareto analysis</h3>

<p>A large majority of problems (80%) are produced by a few key causes (20%). You can use the Editor profiler to identify the most processor-intensive function calls and optimize them first. Often, optimizing a few key functions can give a significant increase in overall execution speed.</p>

<p>You should make sure that functions are only executed when really necessary. For example, you can use events like <em>OnBecameVisible</em> and <em>OnBecameInvisible</em> to detect when an object can’t be seen and avoid updating it. Coroutines can be a useful way to call code that needs regular updates but doesn’t need to run every frame:-</p>

<pre><code>// Do some stuff every frame:
void Update () {
}

//Do some stuff every 0.2 seconds:
IEnumerator SlowUpdate () {
   while (true) {
      //do something
      yield return new WaitForSeconds (0.2f);
   }
}


</code></pre>

<p>You can use the .NET <em>System.Threading.Thread</em> class to run heavy calculations on a separate thread. This allows you to run on multiple cores but note that the Unity API is not thread-safe - you need to buffer inputs and results and read and assign them on the main thread in order to use Unity API calls.</p>

<h2>CPU Profiling</h2>

<h3>Profile user code</h3>

<p>Not all of the user code is shown in the Profiler. But you can use <em>Profiler.BeginSample</em> and <em>Profiler.EndSample</em> to make the required user code appear in the profiler.</p>

<h2>GPU Profiling</h2>

<p>The Unity Editor profiler cannot show GPU data as of now. We’re working with hardware manufacturers to make it happen with the Tegra devices being the first to appear in the Editor profiler.</p>

<h3>Tools for iOS</h3>

<ul>
<li>Unity internal profiler (not the Editor profiler). This shows the GPU time for the whole scene.</li>
<li>PowerVR PVRUniSCo shader analyzer. See below.</li>
<li>iOS: Xcode OpenGL ES Driver Instruments can show only high-level info:

<ul>
<li>“Device Utilization %” - GPU time spent on rendering in total. &gt;95% means the app is GPU bound.</li>
<li>“Renderer Utilization %” - GPU time spent drawing pixels.</li>
<li>“Tiler Utilization %” - GPU time spent processing vertices.</li>
<li>“Split count” - the number of frame splits, where the vertex data didn’t fit into allocated buffers.</li>
</ul>
</li>
</ul>

<p>PowerVR is tile based deferred renderer, so it’s impossible to get GPU timings per draw call. However you can get GPU times for the whole scene using Unity’s built-in profiler (the one that prints results to Xcode output). Apple’s tools currently can only tell you how busy the GPU and its parts are, but do not give times in milliseconds.</p>

<p>PVRUniSCo gives cycles for the whole shader, and approximate cycles for each line in the
shader code. Windows &amp; Mac! But it won’t match what Apple’s drivers are doing exactly anyway. Still, a good ballpark measure. </p>

<h3>Tools for Android</h3>

<ul>
<li>Adreno (Qualcomm)</li>
<li>NVPerfHUD (NVIDIA)</li>
<li>PVRTune, PVRUniSCo (PowerVR)</li>
</ul>

<p>On Tegra, NVIDIA provides excellent performance tools which does everything you want - GPU time per draw call, Cycles per shader, Force 2x2 texture, Null view rectangle, runs on Windows, OSX, Linux. PerfHUD ES does not easily work with consumer devices, you need the development board from NVIDIA.</p>

<p>Qualcomm provides excellent Adreno Profiler (Windows only) which is Windows only, but works with consumer devices! It features Timeline graphs, frame capture, Frame debug, API calls, Shader analyzer, live editing.</p>

<h3>Graphics related CPU profiling</h3>

<p>The internal profiler gives a good overview per module:</p>

<ul>
<li>time spent in OpenGL ES API</li>
<li>batching efficiency</li>
<li>skinning, animations, particles</li>
</ul>

<h2>Profiler Ports</h2>

<p>Ports that the Unity profiler uses:</p>

<ul>
<li>MulticastPort : 54998</li>
<li>ListenPorts : 55000 - 55511</li>
<li>Multicast (unittests) : 55512 - 56023</li>
</ul>

<p>They should be accessible from within the network node. That is, the devices that you’re trying to profile on should be able to see these ports on the machine with the Unity Editor with the Profiler on.</p>

<h2>Memory</h2>

<p>There are two types of memory, Mono memory and Unity memory. </p>

<h3>Mono memory</h3>

<p>Mono memory handles script objects, wrappers for Unity objects (game objects, assets, components, etc). Garbage Collector cleans up when the allocation does not fit in the available memory or on a <em>System.GC.Collect()</em> call.</p>

<p>Memory is allocated in heap blocks. More can allocated if it cannot fit the data into the allocated block. Heap blocks will be kept in Mono until the app is closed. In other words, Mono does not release any memory used to the OS (Unity 3.x). Once you allocate a certain amount of memory, it is reserved for mono and not available for the OS. Even when you release it, it will become available internally for Mono only and not for the OS. The heap memory value in the Profiler will only increase, never decrease.</p>

<p>If the system cannot fit new data into the allocated heap block, the Mono calls a “GC” and can allocate a new heap block (for example, due to fragmentation).</p>

<p>“Too many heap sections” means you’ve run out of Mono memory (because of fragmentation or heavy usage). </p>

<p>Use <code>System.GC.GetTotalMemory</code> to get the total used Mono memory.</p>

<p>The general advice is, use as small an allocation as possible.</p>

<h3>Unity memory</h3>

<p>Unity memory handles Asset data (Textures, Meshes, Audio, Animation, etc), Game objects, Engine internals (Rendering, Particles, Physics, etc).
Use <code>Profiler.usedHeapSize</code> to get the total used Unity memory.</p>

<h3>Memory map</h3>

<p>No tools yet but you can use the following.</p>

<ul>
<li>Unity Profiler - not perfect, skips stuff, but you can get an overview. It works on the device!</li>
<li>Internal profiler. Shows Used heap and allocated heap - see mono memory. Shows the number of mono allocations per frame.</li>
<li>Xcode tools - iOS</li>
<li>Xcode Instruments Activity Monitor - Real Memory column.</li>
<li>Xcode Instruments Allocations - net allocations for created and living objects.</li>
<li>VM Tracker (textures usually get allocated with IOKit label and meshes usually go into VM Allocate).</li>
</ul>

<p>You can also make your own tool using Unity API calls:-</p>

<ul>
<li><code>FindObjectsOfTypeAll (type : Type) : Object[]</code></li>
<li><code>FindObjectsOfType (type : Type): Object[]</code></li>
<li><code>GetRuntimeMemorySize (o : Object) : int</code></li>
<li><code>GetMonoHeapSize</code></li>
<li><code>GetMonoUsedSize</code></li>
<li>
<code>Profiler.BeginSample/EndSample</code> - profile your own code</li>
<li><code>UnloadUnusedAssets () : AsyncOperation</code></li>
<li><code>System.GC.GetTotalMemory/Profiler.usedHeapSize</code></li>
</ul>

<p>References to the loaded objects - There is no way to figure this out. A workaround is to “Find references in scene” for public variables.</p>

<h3>Garbage collector</h3>

<ul>
<li>This fires when the system cannot fit new data into the allocated heap block.</li>
<li>Don’t use <code>OnGUI()</code> on mobiles: it shoots several times per frame, completely redraws the view and creates tons of memory allocation calls that require Garbage Collection to be invoked.</li>
</ul>

<h3>Creating/removing too many objects too quickly?</h3>

<ul>
<li>This may lead to fragmentation.</li>
<li>Use the Editor profiler to track the memory activity.</li>
<li>The internal profiler can be used to track the mono memory activity.</li>
<li>
<code>System.GC.Collect()</code> You can use this <em>.Net</em> function when it’s ok to have a hiccup.</li>
</ul>

<h3>Allocation hiccups</h3>

<ul>
<li>Use lists of preallocated, reusable class instances to implement your own memory management scheme.</li>
<li>Don’t make huge allocations per frame, cache, preallocate instead</li>
<li>Problems with fragmentation?</li>
</ul>

<h3>Preallocating a memory pool.</h3>

<ul>
<li>Keep a List of inactive GameObjects and reuse them instead of Instantiating and Destroying them.</li>
</ul>

<h3>Out of mono memory</h3>

<ul>
<li>Profile memory activity - when does the first memory page fill up?</li>
<li>Do you really need so many gameobjects that a single memory page is not enough?</li>
<li>Use structs instead of classes for local data. Classes are stored on the heap; structs on the stack.</li>
<li>Read the <a href="UnderstandingAutomaticMemoryManagement.html">Understanding Automatic Memory Management</a> page.</li>
</ul>

<h3>Out of memory crashes</h3>

<p>At some points a game may crash with “out of memory” though it in theory it should fit in fine. When this happens compare your normal game memory footprint and the allocated memory size when the crash happens. If the numbers are not similar, then there is a memory spike. This might be due to:</p>

<ul>
<li>Two big scenes being loaded at the same time - use an empty scene between two bigger ones to fix this.</li>
<li>Additive scene loading - remove unused parts to maintain the memory size.</li>
<li>Huge asset bundles loaded to the memory</li>
<li>Textures without proper compression (a no go for mobiles).</li>
<li>Textures having Get/Set pixels enabled. This requires an uncompressed copy of the texture in memory.</li>
<li>Textures loaded from JPEG/PNGs at runtime are essentially uncompressed.</li>
<li>Big mp3 files marked as decompress on loading.</li>
<li>Keeping unused assets in weird caches like static monobehavior fields, which are not cleared when changing scenes.</li>
</ul>
<div class="feedbackbox" id="feedbackbox">
<div id="rating"><p>Did you find this page useful? Please give it a rating:<br><div id="ratecontent" class="c-rating"></div>
</p></div>
<div id="ratingThanks" style="display:none"><p>Thanks for rating this page!</p></div>
<div id="problem"><p><a name="problem" onclick="document.getElementById('problemType').style.display = '';document.getElementById('problem').style.display = 'none';">Report a problem on this page</a></p></div>
<div id="problemType" style="display:none"><p>What kind of problem would you like to report?<ul type="problems">
<li><a name="needcode" onclick="                                                             document.getElementById('problemType').style.display = 'none';                                                             document.getElementById('problemThanks').style.display = '';                                                             SendFeedback('problem-needcode',window.location.href,0);                                                             document.getElementById('problemFormDescription').value='Needs code samples.';                                                             document.getElementById('problemNeedCodeForm').style.display = ''                                                         ">This page needs code samples</a></li>
<li><a name="code" onclick="document.getElementById('problemType').style.display = 'none';                                                         document.getElementById('problemThanks').style.display = '';                                                         SendFeedback('problem-brokencode',window.location.href,0);                                                         document.getElementById('problemFormDescription').value='Code samples do not work.';                                                         document.getElementById('problemCodeForm').style.display = ''                                                         ">Code samples do not work</a></li>
<li><a name="missing" onclick="document.getElementById('problemType').style.display = 'none';                                                         document.getElementById('problemThanks').style.display = '';                                                         SendFeedback('problem-missing',window.location.href,0);                                                         document.getElementById('problemFormDescription').value='Missing information';                                                         document.getElementById('problemMissingForm').style.display = ''                                                         ">Information is missing</a></li>
<li><a name="incorrect" onclick="document.getElementById('problemType').style.display = 'none';                                                         document.getElementById('problemThanks').style.display = '';                                                         SendFeedback('problem-incorrect',window.location.href,0);                                                         document.getElementById('problemFormDescription').value='Incorrect information';                                                         document.getElementById('problemIncorrectForm').style.display = ''                                                         ">Information is incorrect</a></li>
<li><a name="unclear" onclick="document.getElementById('problemType').style.display = 'none';                                                         document.getElementById('problemThanks').style.display = '';                                                         SendFeedback('problem-unclear',window.location.href,0);                                                         document.getElementById('problemFormDescription').value='Unclear or confusing information';                                                         document.getElementById('problemUnclearForm').style.display = ''                                                         ">Information is unclear or confusing</a></li>
<li><a name="language" onclick="document.getElementById('problemType').style.display = 'none';                                                         document.getElementById('problemThanks').style.display = '';                                                         SendFeedback('problem-language',window.location.href,0);                                                         document.getElementById('problemFormDescription').value='Spelling or grammar error';                                                         document.getElementById('problemLanguageForm').style.display = ''                                                         ">There is a spelling/grammar error on this page</a></li>
<li><a name="other" onclick="document.getElementById('problemType').style.display = 'none';                                                         document.getElementById('problemThanks').style.display = '';                                                         SendFeedback('problem-other',window.location.href,0);                                                         document.getElementById('problemFormDescription').value='This page has a problem';                                                         document.getElementById('problemOtherForm').style.display = ''                                                         ">Something else</a></li>
</ul>
<p><known_issues><p>Is something described here not working as you expect it to? It might be a <b>Known Issue</b>. Please check with the Issue Tracker at <a href="https://issuetracker.unity3d.com">issuetracker.unity3d.com</a>.</p></known_issues></p>
</p></div>
<div id="problemThanks" style="display:none"><p>Thanks for letting us know! This page has been marked for review based on your feedback.<br><br>If you have time, you can provide more information to help us fix the problem faster.<br><br><a onclick="document.getElementById('problemMoreInfo').style.display = '';document.getElementById('problemThanks').style.display = 'none';">Provide more information</a><br>
</p></div>
<div id="problemMoreInfo" style="display:none">
<p id="problemNeedCodeForm" style="display:none">You've told us this page needs code samples. If you'd like to help us further, you could provide a code sample, or tell us about what kind of code sample you'd like to see:</p>
<p id="problemCodeForm" style="display:none">You've told us there are code samples on this page which don't work. If you know how to fix it, or have something better we could use instead, please let us know:</p>
<p id="problemMissingForm" style="display:none">You've told us there is information missing from this page. Please tell us more about what's missing:</p>
<p id="problemIncorrectForm" style="display:none">You've told us there is incorrect information on this page. If you know what we should change to make it correct, please tell us:</p>
<p id="problemUnclearForm" style="display:none">You've told us this page has unclear or confusing information. Please tell us more about what you found unclear or confusing, or let us know how we could make it clearer:</p>
<p id="problemLanguageForm" style="display:none">You've told us there is a spelling or grammar error on this page. Please tell us what's wrong:</p>
<p id="problemOtherForm" style="display:none">You've told us this page has a problem. Please tell us more about what's wrong:</p>
<form>
<textarea id="problemFormSuggestionField" cols="40" rows="5"></textarea><input type="hidden" id="problemFormDescription"><input type="submit" id="problemFormDescriptionSubmit" value="Submit" onclick="                                             document.getElementById('problemMoreInfo').style.display = 'none';                                             document.getElementById('problemMoreInfoThanks').style.display = '';                                             return false;                                             ">
</form>
</div>
<div id="problemMoreInfoThanks" style="display:none"><p>Thanks for helping to make the Unity documentation better!</p></div>
<script>

                                            var ratecontent = document.querySelector('#ratecontent'); // target element
                                            var currentRating = 0; // initial rating
                                            var maxRating= 5; // max rating

                                            // callback to run after setting the rating
                                            var callback = function(rating) {
                                                document.getElementById('ratingThanks').style.display = '';
                                                document.getElementById('ratecontent').style.display = 'none';
                                                document.getElementById('rating').style.display = 'none';
                                                SendFeedback("rating",window.location.href,rating);
                                            };

                                            // rating instance
                                            var myRating = rating(ratecontent, currentRating, maxRating, callback);
                                        </script>
</div>
<div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="MobileCrashes.html"></a></span><div class="tip">Crashes</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="MobileOptimisation.html"></a></span><div class="tip">Optimizations</div>
</div>
</div>
</div>
</body></html>